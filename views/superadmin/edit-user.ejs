<%- include('../partials/superadmin/header.ejs') %>
    <%- include('../partials/superadmin/navbar.ejs') %>

        <!-- Main Content -->
        <main class="col-md-9 col-lg-10">
            <%- include('../partials/superadmin/profile.ejs') %>
            <div class="container my-5">
                <h2 class="mb-4">Update User's Details</h2>

                <% if (successMessage) { %>
                <div id="successBox" class="alert alert-success" role="alert">
                    <%= successMessage %>
                </div>
                <% } %>
                <% if (errorMessage) { %>
                    <div id="successBox" class="alert alert-danger" role="alert">
                        <%= errorMessage %>
                    </div>
                    <% } %>
                <!-- user Details Form -->
                <form method="POST" id="myForm" onsubmit="submitForm(event)">
                    <div class="mb-3">
                        <label for="userName" class="form-label">Username</label>
                        <input type="text" class="form-control" maxlength="100" name="name" id="userName"
                            placeholder="Enter username" value="<%= user.name %>" oninput="checkInputs('nameUserError', 'userName')" required>
						<p id="nameUserError" class="mt-2 d-none text-danger">*Username can't exceed 100 characters!</p>
                    </div>
                    <div class="mb-3">
                      <label for="orgName" class="form-label">Organization Name</label>
                      <input type="text" class="form-control" name="orgName" id="orgName"
                          placeholder="Enter organization name" value="<%= user.orgName %>" disabled>
                    </div>
					          <div class="mb-3">
                        <label for="userRole" class="form-label">Role</label>
                        <select id="userRole" name="role" class="form-select" oninput="checkInputs()" required>

                            <% roles.forEach(role=> { %>
                                <option value="<%= role.name %>" <%=role.name===user.role ? 'selected' : '' %> >
                                    <%= role.name.charAt(0).toUpperCase() + role.name.slice(1).toLowerCase() %>
                                </option>
                                <% }); %>
                        </select>
                    </div>
					          <div class="mb-3">
                        <label for="userEmail" class="form-label" id="labelEmail">Email Address</label>
                        <input type="email" class="form-control" maxlength="45" name="email" id="userEmail"
                            placeholder="Enter email address" value="<%= user.email %>" oninput="checkInputs('emailUserError', 'userEmail')" required>
						<p id="emailUserError" class="mt-2 d-none text-danger">*Email Address can't exceed 45 characters!</p>
                    </div>
                    <div class="mb-3">
                        <label for="userPhone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" maxlength="45" id="userPhone" name="phone"
                            placeholder="Enter phone number" value="<%= user.phone %>" oninput="checkInputs('phoneUserError', 'userPhone')" required>
						<p id="phoneUserError" class="mt-2 d-none text-danger">*Phone can't exceed 45 characters!</p>
                    </div>
                    <div class="mb-3">
                        <label for="userStatus" class="form-label">Status</label>
                        <select id="userStatus" name="status" class="form-select" oninput="checkInputs()" required>

                            <% options.forEach(option=> { %>
                                <option value="<%= option.name %>" <%=option.name===user.status ? 'selected' : '' %> >
                                    <%= option.name.toUpperCase() %>
                                </option>
                                <% }); %>
                        </select>
                    </div>
                    <button onclick="clickBtn('update', '<%= user.id %>')" type="submit" id="updateBtn" class="btn btn-success w-100 mb-2">Update</button>
                    <a onclick="clickBtn()" href="#" id="resetBtn" class="btn w-100"></a>
				</form>
                <br>
                <p>The last updated by <strong id="updatedBy"><%= user.superadminName %></strong> at <span id="updatedAt"
                    class="fw-bold">
                    <%= new Date(user.updatedAt).toString().split('GMT')[0]; %>
                    </span>
                </p>
            </div>
			<script>
                // Click Btns
                let url = new URL(window.location.href);
				const searchParams = new URLSearchParams(window.location.search);
                
                let orgName = url.searchParams.get( 'orgName' )
                let orgStatus = url.searchParams.get( 'orgStatus' )
                let orgPage = url.searchParams.get( 'orgPage' )
                let expired = url.searchParams.get( 'expired' )
                let query = "?"
                
                if (orgPage) {
                    query += "orgPage=" + orgPage
                } else {
                    query += "orgPage=1"
                }

                if (orgName) {
                    query += "&orgName=" + orgName
                }

                if (orgStatus) {
                    query += "&orgStatus=" + orgStatus
                }

                if (expired) {
                    query += "&expired=" + expired
                }

                let userName = url.searchParams.get( 'userName' )
                let userStatus = url.searchParams.get( 'userStatus' )
                let userPage = url.searchParams.get( 'userPage' )
                let userRole = url.searchParams.get( 'userRole' )
                let userQuery = "&"
                
                if (userPage) {
                    userQuery += "userPage=" + userPage
                } else {
                    userQuery += "userPage=1"
                }

                if (userName) {
                    userQuery += "&userName=" + userName
                }

                if (userStatus) {
                    userQuery += "&userStatus=" + userStatus
                }

                if (userRole) {
                    userQuery += "&userRole=" + userRole
                }

                let orgId = "<%= orgId %>"

                function clickBtn( type, num ) {
                    window.location.href = '/superadmin/organizations/detail/' + orgId + query + userQuery + '&activeUsers=true'
                }
                // xxx
                function buttonType() {
					const resetBtn = document.getElementById("resetBtn")
                    const type = searchParams.get('type')
	                if (type == 'update') {
						resetBtn.innerText = "Back"
						resetBtn.classList.add("btn-primary")
	                }
					else {
						resetBtn.innerText = "Cancel"
						resetBtn.classList.add("btn-danger")
					}

	            }

	            buttonType();

                const form = document.getElementById('myForm');
                const updateBtn = document.getElementById('updateBtn');
                const inputs = form.querySelectorAll('.form-control[required]:not([readonly])');
				const userEmail = document.getElementById('userEmail')
				const labelEmail = document.getElementById('labelEmail')

				const userOldName = "<%= user.name %>"
                const userOldRole = "<%= user.role %>"
				const userOldEmail = "<%= user.email %>"
				const userOldPhone = "<%= user.phone %>"
				const userOldStatus = "<%= user.status %>"

                function checkInputs(messageBox, inputField) {

									const userNameValue = document.getElementById('userName').value
                                    const userRoleValue = document.getElementById('userRole').value
									const userEmailValue = document.getElementById('userEmail').value
									const userPhoneValue = document.getElementById('userPhone').value
									const userStatusValue = document.getElementById('userStatus').value

									if ( (userOldName == userNameValue) && (userOldRole == userRoleValue) && (userOldEmail == userEmailValue) && (userOldPhone == userPhoneValue) && (userOldStatus == userStatusValue) ) {
										updateBtn.classList.add('disabled')
									} else {
										updateBtn.classList.remove('disabled')
									}

	                let allFilled = true;
	                inputs.forEach(index => {
	                if (!index.value.trim()) {
	                    allFilled = false;
	                }
	                });
	                updateBtn.disabled = !allFilled;
					const message = document.getElementById(messageBox)
					const input = document.getElementById(inputField)
					if (input.value.length === parseInt(input.maxLength)) {
				        message.classList.remove('d-none');
				    } else {
				        message.classList.add('d-none');
				    }
					if (inputField === 'userEmail')
					{
						userEmail.classList.remove('border-danger')
						labelEmail.style.color = 'black'
						userEmail.classList.remove('input-error')
					}
	            }

							checkInputs();


                function submitForm(event) {
				    updateBtn.disabled = true;
				    updateBtn.textContent = 'Submitting...';
				}
				
				const error = searchParams.get('error')

				if (error === 'true') {
					const type = searchParams.get('type')
					if (type === 'dup-email') {
						userEmail.classList.add('border-danger')
						labelEmail.style.color = '#bb2124'
						userEmail.onfocus = function() {
				            userEmail.classList.add('input-error');
				        };
				        
				        userEmail.onblur = function() {
				            userEmail.classList.remove('input-error');
				        };
					}
				}
				
			</script>
        </main>

        <%- include('../partials/superadmin/footer.ejs') %>