<%- include('../partials/superadmin/header.ejs') %>
    <%- include('../partials/superadmin/navbar.ejs') %>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Main Content -->
        <main class="col-md-9 col-lg-10">
            <div class="container my-5">
                <h2 class="mb-4">Update Organization</h2>

				<% if (errorMessage) { %>
                    <div id="errorBox" class="alert alert-danger" role="alert">
                        <%= errorMessage %>
                    </div>
                    <% } %>
                <% if (successMessage) { %>
                <div id="successBox" class="alert alert-success" role="alert">
                    <%= successMessage %>
                </div>
                <% } %>
                <!-- Organization Details Form -->
                <form class="mb-4" method="POST" id="myForm" onsubmit="submitForm(event)">
                    <div class="mb-3">
                        <label for="orgName" class="form-label">Organization Name</label>
                        <input type="text" class="form-control" maxlength="145" name="name" id="orgName"
                            placeholder="Enter organization name" value="<%= org.name %>" oninput="checkInputs('nameOrgError', 'orgName')" required>
						<p id="nameOrgError" class="mt-2 d-none text-danger">*Organization Name can't exceed 145 characters!</p>
                    </div>
                    <div class="mb-3">
                        <label for="orgAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="orgAddress" maxlength="145" name="address" rows="2"
                            placeholder="Enter organization address" oninput="checkInputs('addressOrgError', 'orgAddress')" required><%= org.address %></textarea>
						<p id="addressOrgError" class="mt-2 d-none text-danger">*Address can't exceed 145 characters!</p>
                    </div>
                    <div class="mb-3">
                        <label for="orgPhone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" maxlength="45" id="orgPhone" name="phone"
                            placeholder="Enter phone number" value="<%= org.phone %>" oninput="checkInputs('phoneOrgError', 'orgPhone')" required>
						<p id="phoneOrgError" class="mt-2 d-none text-danger">*Phone can't exceed 45 characters!</p>
                    </div>
                    <div class="mb-3">
                        <label for="orgStatus" class="form-label">Status</label>
                        <select id="orgStatus" name="status" class="form-select" required>

                            <% options.forEach(option=> { %>
                                <option value="<%= option.name %>" <%=option.name===org.status ? 'selected' : '' %> >
                                    <%= option.name.toUpperCase() %>
                                </option>
                                <% }); %>
                        </select>
                    </div>
                    <button type="submit" id="addBtn" class="btn btn-success w-100 mb-2">Update Organization</button>
                    <a href="/superadmin/organizations?page=<%= page %>" class="btn w-100" id="resetBtn"></a>

                </form>

                <!-- License Extension -->
                <div>
                    <h4>License Extension</h4>
                    <p>Extend the organization's license expiration date:</p>
                    <div class="d-flex gap-2" id="license-buttons">
						<a href="" class="btn btn-outline-secondary" onclick="expireNow()" id="expireNowBtn" data-bs-toggle="modal"
						data-bs-target="#confirmationModal">Expire Now</a>
						<a href="/superadmin/organizations/license/<%= org.id %>?num=-1&type=month&page=<%= page %>" class="btn btn-outline-secondary reduceLicense" data-type="month" data-num="-1">-1 Months</a>
						<a href="/superadmin/organizations/license/<%= org.id %>?num=-7&type=day&page=<%= page %>" class="btn btn-outline-secondary reduceLicense" data-type="day" data-num="-7">-7 Days</a>
						<a href="/superadmin/organizations/license/<%= org.id %>?num=-1&type=day&page=<%= page %>" class="btn btn-outline-secondary reduceLicense" data-type="day" data-num="-1">-1 Day</a>
						<a href="/superadmin/organizations/license/<%= org.id %>?num=1&type=day&page=<%= page %>" class="btn btn-outline-secondary" data-type="day" data-num="1">+1 Day</a>
						<a href="/superadmin/organizations/license/<%= org.id %>?num=7&type=day&page=<%= page %>" class="btn btn-outline-secondary" data-type="day" data-num="7">+7 Days</a>
						<a href="/superadmin/organizations/license/<%= org.id %>?num=1&type=month&page=<%= page %>" class="btn btn-outline-secondary" data-type="month" data-num="1">+1 Months</a>
					</div>
                    <p class="mt-3">Current Expiration Date: <span id="currentExpirationDate" class="fw-bold"></span>
                            <%= new Date(org.expiredDate).toDateString() %>
                        </span></p>
                </div>
				<!-- Modal HTML -->
				<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<p>The license will expire <strong>now</strong>. Do you want to proceed?</p>
								<p>To confirm, type <strong>confirm</strong> in the box below:</p>
								<input type="text" id="confirmationInput" class="form-control" placeholder="Type 'confirm' here" oninput="handleInput()">
								<div id="errorMsg" class="text-danger mt-2" style="display: none;">Please type "confirm" to proceed.</div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
								<button type="button" class="btn btn-primary" id="confirmBtn" disabled>Yes</button>
							</div>
						</div>
					</div>
				</div>
            </div>
			<script>
				const orgExpiredDate = new Date("<%= org.expiredDate %>");
			    const today = new Date();
				const confirmInput = document.getElementById("confirmationInput");
	            const confirmBtn = document.getElementById("confirmBtn");
	            const errorMsg = document.getElementById("errorMsg");

				function handleInput() {
	                if (confirmInput.value.toLowerCase() === "confirm") {
	                    confirmBtn.disabled = false;
	                    errorMsg.style.display = "none";
	                } else {
	                    confirmBtn.disabled = true;
	                }
	            };
				function expireNow() {
		            const expireDays = Math.ceil(orgExpiredDate/ (1000 * 60 * 60 * 24)) - Math.ceil(today/ (1000 * 60 * 60 * 24));
		            confirmInput.value = "";
		            confirmBtn.disabled = true;
		            errorMsg.style.display = "none";
					
		            confirmBtn.onclick = function () {
		                const newHref = `/superadmin/organizations/license/<%= org.id %>?num=-${expireDays}&type=day&page=<%= page %>`;
		                window.location.href = newHref; 
		            };
				}


				function buttonType() {
	                const searchParams = new URLSearchParams(window.location.search);
	                const type = searchParams.get('type')
					const resetBtn = document.getElementById("resetBtn")
	                if (type == 'update'  || type == "extendLicense" || type == "reduceLicense") {
						resetBtn.innerText = "Back"
						resetBtn.classList.add("btn-primary")
	                }
					else {
						resetBtn.innerText = "Cancel"
						resetBtn.classList.add("btn-danger")
					}

	            }
	            buttonType();

                const addButton = document.getElementById('addBtn');
				const form = document.getElementById('myForm');
				const inputs = form.querySelectorAll('.form-control[required]:not([readonly])');

                function checkInputs(messageBox, inputField) {
                    let allFilled = true;
                    inputs.forEach(index => {
                    if (!index.value.trim()) {
                        allFilled = false;
                    }
                    });
                    addButton.disabled = !allFilled;
					const message = document.getElementById(messageBox)
					const input = document.getElementById(inputField)
					if (input.value.length === parseInt(input.maxLength)) {
				        message.classList.remove('d-none');
				    } else {
				        message.classList.add('d-none');
				    }
                }

				function submitForm(event) {
				    addButton.disabled = true;
				    addButton.textContent = 'Submitting...';
				}
				

			    document.querySelectorAll('.reduceLicense').forEach(button => {
			        const num = parseInt(button.dataset.num);
			        const type = button.dataset.type;
			        let newExpiry = new Date(orgExpiredDate);

			        if (type === 'month') {
			            newExpiry.setMonth(newExpiry.getMonth() + num);
			        } else if (type === 'day') {
			            newExpiry.setDate(newExpiry.getDate() + num);
			        }

			        if (newExpiry <= today) {
			            button.classList.add('d-none');
			            button.setAttribute('d-none', true);
			        }
			    });

			</script>
        </main>

        <%- include('../partials/superadmin/footer.ejs') %>